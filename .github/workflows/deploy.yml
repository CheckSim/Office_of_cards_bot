name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Nome del progetto (usato per la directory sul Pi)
  PROJECT_NAME: ${{ github.event.repository.name }}
  
  # Path base dove sono i progetti sul Pi (modificabile)
  BASE_PATH: ~/projects

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:ci
    
    - name: Deploy to Raspberry Pi
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        envs: PROJECT_NAME,BASE_PATH,ENV_FILE
        script: |
          set -e
          
          PROJECT_DIR="$BASE_PATH/$PROJECT_NAME"
          
          echo "üöÄ Starting deployment for $PROJECT_NAME"
          
          # Crea la directory se non esiste e clona il repo
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "üìÅ Directory not found, cloning repository..."
            mkdir -p "$BASE_PATH"
            cd "$BASE_PATH"
            git clone git@github.com:${{ github.repository }}.git
          fi
          
          cd "$PROJECT_DIR"
          
          # Pull delle ultime modifiche
          echo "‚¨áÔ∏è  Pulling latest changes..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          
          # Crea il file .env dai secrets di GitHub
          if [ ! -z "$ENV_FILE" ]; then
            echo "üîê Creating .env file from secrets..."
            echo "$ENV_FILE" > .env
            chmod 600 .env
            echo "‚úÖ .env file created"
          else
            echo "‚ÑπÔ∏è  No ENV_FILE secret found, skipping .env creation"
          fi
          
          # Gestione Node.js (se presente package.json)
          if [ -f "package.json" ]; then
            echo "üì¶ Node.js project detected"
            
            # Installa dipendenze se package.json √® cambiato
            npm install
            
            # Build se presente script build
            if grep -q '"build"' package.json; then
              echo "üî® Running build..."
              npm run build
            fi
            
            # Riavvia con PM2 (se installato)
            if command -v pm2 &> /dev/null; then
              echo "üîÑ Restarting with PM2..."
              pm2 restart "$PROJECT_NAME" || pm2 start npm --name "$PROJECT_NAME" -- start
            else
              echo "‚ö†Ô∏è  PM2 not found, skipping process restart"
            fi
          
          # Gestione Python (se presente requirements.txt)
          elif [ -f "requirements.txt" ]; then
            echo "üêç Python project detected"
            
            # Crea venv se non esiste
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Riavvia con systemd (se configurato)
            if systemctl --user list-units --all | grep -q "$PROJECT_NAME"; then
              echo "üîÑ Restarting systemd service..."
              systemctl --user restart "$PROJECT_NAME"
            else
              echo "‚ö†Ô∏è  Systemd service not found, skipping restart"
            fi
          
          # Gestione Docker (se presente docker-compose.yml e risorse sufficienti)
          elif [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            echo "üê≥ Docker Compose found"
            echo "‚ö†Ô∏è  Warning: Docker pu√≤ essere pesante su Raspberry Pi 2 (1GB RAM)"
            echo "üîÑ Rebuilding containers..."
            docker-compose down
            docker-compose up -d --build
            echo "‚úÖ Docker containers started"
          
          else
            echo "‚ÑπÔ∏è  No recognized project type (Docker/Node/Python)"
            echo "‚úÖ Files updated, manual restart may be needed"
          fi
          
          echo "‚ú® Deployment completed successfully!"
      env:
        ENV_FILE: ${{ secrets.ENV_FILE }}
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment successful"
        else
          echo "‚ùå Deployment failed"
        fi