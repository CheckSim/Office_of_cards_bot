name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BASE_PATH: /home/pi/projects

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:ci

    - name: Deploy to Raspberry Pi
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60m
        command_timeout: 60m
        envs: >
          PROJECT_NAME,
          BASE_PATH,
          ENV_FILE,
          GH_TOKEN_DEPLOY,
          PYTHON_VERSION
        script: |
          set -e

          echo "ðŸš€ Starting deployment for $PROJECT_NAME"
          echo "ðŸ‘¤ User: $(whoami)"
          echo "ðŸ“ Base path: $BASE_PATH"

          PROJECT_DIR="$BASE_PATH/$PROJECT_NAME"
          REPO_URL="https://${{ secrets.GH_TOKEN_DEPLOY }}@github.com/${{ github.repository }}.git"

          # --------------------------------------------------
          # Clone or update repository
          # --------------------------------------------------
          if [ ! -d "$PROJECT_DIR/.git" ]; then
            echo "ðŸ“ Cloning repository..."
            mkdir -p "$BASE_PATH"
            git clone "$REPO_URL" "$PROJECT_DIR"
          fi

          cd "$PROJECT_DIR"
          git remote set-url origin "$REPO_URL"

          echo "â¬‡ï¸  Fetching latest changes..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

          # --------------------------------------------------
          # ENV file
          # --------------------------------------------------
          if [ -n "$ENV_FILE" ]; then
            echo "ðŸ” Writing .env file..."
            printf '%s\n' "$ENV_FILE" > .env
            chmod 600 .env
            echo "âœ… .env file created with $(wc -l < .env) lines"
          else
            echo "â„¹ï¸  No ENV_FILE provided"
          fi

          # --------------------------------------------------
          # Node.js project
          # --------------------------------------------------
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Node.js project detected"

            if ! command -v npm >/dev/null 2>&1; then
              echo "ðŸ“¦ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            npm install

            if npm run | grep -q "build"; then
              echo "ðŸ”¨ Running build..."
              npm run build
            fi

            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart "$PROJECT_NAME" || pm2 start npm --name "$PROJECT_NAME" -- start
              echo "âœ… PM2 service restarted"
            else
              echo "âš ï¸  PM2 not installed"
            fi

          # --------------------------------------------------
          # Python project
          # --------------------------------------------------
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ Python project detected"

            # Determina la versione di Python da usare
            if [ -n "$PYTHON_VERSION" ]; then
              PYTHON_BIN="python${PYTHON_VERSION}"
            else
              PYTHON_BIN="python3"
            fi

            if ! command -v $PYTHON_BIN >/dev/null 2>&1; then
              echo "âŒ $PYTHON_BIN not found, please install it manually on Raspberry"
              exit 1
            fi

            echo "ðŸ Using $PYTHON_BIN ($(command -v $PYTHON_BIN))"

            # Crea virtual environment se non esiste
            if [ ! -d "venv" ]; then
              echo "ðŸ“¦ Creating virtual environment..."
              $PYTHON_BIN -m venv venv
            fi

            # Attiva venv e installa dipendenze
            source venv/bin/activate

            export PIP_PREFER_BINARY=1

            echo "ðŸ“¦ Installing dependencies..."
            pip install --upgrade pip setuptools wheel
            pip install -r requirements.txt

            # Trova il file principale Python
            MAIN_FILE=""
            if [ -f "main.py" ]; then
              MAIN_FILE="main.py"
            elif [ -f "bot.py" ]; then
              MAIN_FILE="bot.py"
            elif [ -f "app.py" ]; then
              MAIN_FILE="app.py"
            elif [ -f "run.py" ]; then
              MAIN_FILE="run.py"
            else
              echo "âš ï¸  No standard Python entry point found (main.py, bot.py, app.py, run.py)"
              MAIN_FILE="main.py"  # Default
            fi

            echo "ðŸŽ¯ Entry point: $MAIN_FILE"

            # Crea o aggiorna il servizio systemd
            SERVICE_FILE="/etc/systemd/system/${PROJECT_NAME}.service"
            
            if [ ! -f "$SERVICE_FILE" ]; then
              echo "ðŸ“ Creating systemd service..."
              
              sudo tee "$SERVICE_FILE" > /dev/null <<EOF
          [Unit]
          Description=$PROJECT_NAME
          After=network.target

          [Service]
          Type=simple
          User=$(whoami)
          WorkingDirectory=$PROJECT_DIR
          ExecStart=$PROJECT_DIR/venv/bin/python $MAIN_FILE
          Restart=always
          RestartSec=10
          Environment="PATH=$PROJECT_DIR/venv/bin:/usr/local/bin:/usr/bin:/bin"

          [Install]
          WantedBy=multi-user.target
          EOF

              sudo systemctl daemon-reload
              sudo systemctl enable "$PROJECT_NAME"
              echo "âœ… Systemd service created and enabled"
            else
              echo "â„¹ï¸  Systemd service already exists"
            fi

            # Riavvia il servizio
            echo "ðŸ”„ Restarting systemd service..."
            sudo systemctl restart "$PROJECT_NAME"
            
            # Aspetta un attimo per verificare lo stato
            sleep 2
            
            if sudo systemctl is-active --quiet "$PROJECT_NAME"; then
              echo "âœ… Service is running"
              sudo systemctl status "$PROJECT_NAME" --no-pager -l
            else
              echo "âŒ Service failed to start. Last logs:"
              sudo journalctl -u "$PROJECT_NAME" -n 20 --no-pager
              exit 1
            fi

          # --------------------------------------------------
          # Docker Compose
          # --------------------------------------------------
          elif [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            echo "ðŸ³ Docker Compose detected"
            docker compose down
            docker compose up -d --build
            echo "âœ… Docker containers started"

          else
            echo "â„¹ï¸  No known project type detected"
          fi

          echo "âœ¨ Deployment completed successfully"
      env:
        ENV_FILE: ${{ secrets.ENV_FILE }}

    - name: Deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment successful"
        else
          echo "âŒ Deployment failed"
        fi