name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: ${{ github.event.repository.name }}
  BASE_PATH: /home/pi/projects

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:ci

    - name: Deploy to Raspberry Pi
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30m
        command_timeout: 30m
        envs: >
          PROJECT_NAME,
          BASE_PATH,
          ENV_FILE,
          GH_TOKEN_DEPLOY
        script: |
          set -e

          echo "üöÄ Starting deployment for $PROJECT_NAME"
          echo "üë§ User: $(whoami)"
          echo "üìÅ Base path: $BASE_PATH"

          PROJECT_DIR="$BASE_PATH/$PROJECT_NAME"
          REPO_URL="https://${{secrets.GH_TOKEN_DEPLOY}}@github.com/${{ github.repository }}.git"

          # --------------------------------------------------
          # Bootstrap: required tools
          # --------------------------------------------------
          echo "üîç Checking required tools..."

          sudo apt-get update -y

          for pkg in git curl python3 python3-venv; do
            if ! command -v ${pkg%%-*} >/dev/null 2>&1; then
              echo "üì¶ Installing $pkg..."
              sudo apt-get install -y "$pkg"
            fi
          done

          # --------------------------------------------------
          # Python build dependencies (ARM / Raspberry safe)
          # --------------------------------------------------
          echo "üêç Installing Python system dependencies..."

          sudo apt-get update -y

          sudo apt-get install -y \
            build-essential \
            python3-dev \
            python3-venv \
            python3-pip \
            libopenblas-dev \
            liblapack-dev \
            gfortran \
            libffi-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            zlib1g-dev \
            libpq-dev \
            pkg-config \
            rustc \
            cargo

          # --------------------------------------------------
          # Clone or update repository
          # --------------------------------------------------
          if [ ! -d "$PROJECT_DIR/.git" ]; then
            echo "üìÅ Cloning repository..."
            mkdir -p "$BASE_PATH"
            git clone "$REPO_URL" "$PROJECT_DIR"
          fi

          cd "$PROJECT_DIR"
          git remote set-url origin "$REPO_URL"

          echo "‚¨áÔ∏è  Fetching latest changes..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}

          # --------------------------------------------------
          # ENV file
          # --------------------------------------------------
          if [ -n "$ENV_FILE" ]; then
            echo "üîê Writing .env file"
            echo "$ENV_FILE" > .env
            chmod 600 .env
          else
            echo "‚ÑπÔ∏è  No ENV_FILE provided"
          fi

          # --------------------------------------------------
          # Node.js project
          # --------------------------------------------------
          if [ -f "package.json" ]; then
            echo "üì¶ Node.js project detected"

            if ! command -v npm >/dev/null 2>&1; then
              echo "üì¶ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            npm install

            if npm run | grep -q "build"; then
              echo "üî® Running build..."
              npm run build
            fi

            if command -v pm2 >/dev/null 2>&1; then
              pm2 restart "$PROJECT_NAME" || pm2 start npm --name "$PROJECT_NAME" -- start
            else
              echo "‚ö†Ô∏è  PM2 not installed"
            fi

          # --------------------------------------------------
          # Python project
          # --------------------------------------------------
          elif [ -f "requirements.txt" ]; then
            echo "üêç Python project detected"

            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            if sudo systemctl list-units --type=service | grep -q "$PROJECT_NAME"; then
              echo "üîÑ Restarting systemd service..."
              sudo systemctl restart "$PROJECT_NAME"
            else
              echo "‚ö†Ô∏è  systemd service not found"
            fi

          # --------------------------------------------------
          # Docker Compose
          # --------------------------------------------------
          elif [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
            echo "üê≥ Docker Compose detected"
            docker compose down
            docker compose up -d --build

          else
            echo "‚ÑπÔ∏è  No known project type detected"
          fi

          echo "‚ú® Deployment completed successfully"

    - name: Deployment result
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ Deployment successful"
        else
          echo "‚ùå Deployment failed"
        fi
